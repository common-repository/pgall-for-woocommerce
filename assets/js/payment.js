jQuery(function(n){"use strict";var e=n(_pafw.checkout_form_selector),s={$forms:[],is_blocked:function(e){return e.is(".processing")||e.parents(".processing").length},block:function(e){s.is_blocked(e)||(e.addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),s.$forms.push(e))},unblock:function(){_.each(s.$forms,function(e,t){e.removeClass("processing").unblock()}),s.$forms=[]}},o=(n.fn.pafw_hook={hooks:[],add_filter:function(e,t){void 0===n.fn.pafw_hook.hooks[e]&&(n.fn.pafw_hook.hooks[e]=[]),n.fn.pafw_hook.hooks[e].push(t)},apply_filters:function(e,t){if(void 0!==n.fn.pafw_hook.hooks[e])for(var o=0;o<n.fn.pafw_hook.hooks[e].length;++o)t[0]=n.fn.pafw_hook.hooks[e][o](t);return t[0]}},n.fn.pafw=function(t){if("object"==typeof(t=t||{}))return this.each(function(){var e=n.extend({paymentMethods:_pafw.gateway,isOrderPay:_pafw.is_checkout_pay_page,isSimplePay:!1,ajaxUrl:_pafw.ajax_url,slug:_pafw.slug,gatewayDomain:_pafw.gateway_domain},t);new o(n(this),e)}),this;throw new Error("잘못된 호출입니다.: "+t)},function(e,t){void 0===e.data("pafw")&&(this.$paymentForm=e,this.options=t||{},this.uuid=this._generateUUID(),this._registerHandler(),e.data("pafw",this))});o.prototype._ajaxUrl=function(){var e;return"yes"===this.options.isSimplePay?1<(e=this.options.ajaxUrl.split("?")).length?e[0]+"?action="+this.options.slug+"-pafw_simple_payment&"+e[1]:this.options.ajaxUrl+"?action="+this.options.slug+"-pafw_simple_payment":wc_checkout_params.checkout_url},o.prototype._generateUUID=function(){var o=(new Date).getTime();return"pafw_"+"xxxxxxxxxxxxxxxxxxxx".replace(/[x]/g,function(e){var t=(o+16*Math.random())%16|0;return o=Math.floor(o/16),("x"===e?t:3&t|8).toString(16)})},o.prototype._paymentComplete=function(e){window.location.href=e},o.prototype._paymentCancel=function(){n("#"+this.uuid).remove(),s.unblock()},o.prototype._paymentFail=function(e){alert(e),n("#"+this.uuid).remove(),s.unblock()},o.prototype._registerHandler=function(){this.gateways=n.fn.pafw_hook.apply_filters("pafw_gateway_objects",[this.options.paymentMethods]);var e=_.flatten(_.values(this.options.paymentMethods)).map(function(e){return"checkout_place_order_"+e}).join(" ");this.options.isOrderPay?this.$paymentForm.on("submit",this.processOrderPay.bind(this)):this.$paymentForm.on(e,this.processPayment.bind(this))},o.prototype._processPostMessage=function(e){e.origin!==this.options.gatewayDomain||"pafw_cancel_payment"!==e.data.action&&"pafw_payment_fail"!==e.data.action||n.fn.payment_fail(e.data.message)},o.prototype._registerPaymentCallback=function(){n.fn.payment_complete=this._paymentComplete.bind(this),n.fn.payment_cancel=this._paymentCancel.bind(this),n.fn.payment_fail=this._paymentFail.bind(this),_.isUndefined(n.fn.pafwPostMessageHandler)||window.removeEventListener("message",n.fn.pafwPostMessageHandler,!0),n.fn.pafwPostMessageHandler=this._processPostMessage.bind(this),window.addEventListener("message",n.fn.pafwPostMessageHandler,!0)},o.prototype.openPaymentWindow=function(e,t){_.isUndefined(t.redirect_url)||_.isEmpty(t.redirect_url)?(document.getElementById(e)||n(document.body).append('<div id="'+e+'" style="width: 100%;height: 100%;position: fixed;top: 0;z-index: 99999;"></div>'),n("#"+e).empty().append(t.payment_form)):window.location.href=t.redirect_url},o.prototype.processPayment=function(){var e=this.uuid,a=this;return s.is_blocked(this.$paymentForm)||(s.block(this.$paymentForm),this._registerPaymentCallback(),n.ajax({type:"POST",url:this._ajaxUrl(),data:this.$paymentForm.serialize(),success:function(t){var o="";try{if(0<=(t=0<=t.indexOf("\x3c!--WC_START--\x3e")?t.split("\x3c!--WC_START--\x3e")[1]:t).indexOf("\x3c!--WC_END--\x3e")&&(t=t.split("\x3c!--WC_END--\x3e")[0]),"success"===(o=n.parseJSON(t)).result)a.openPaymentWindow(e,o);else{if("failure"!==o.result||!o.messages)throw"Invalid response";alert(o.messages),s.unblock()}}catch(e){!0===o.reload||"true"===o.reload?window.location.reload():(n(".woocommerce-error, .woocommerce-message").remove(),o.messages?a.$paymentForm.prepend(o.messages):a.$paymentForm.prepend(t),a.$paymentForm.find(".input-text, select").blur(),n("html, body").animate({scrollTop:a.$paymentForm.offset().top-100},1e3),"true"===o.refresh&&n("body").trigger("update_checkout"),n("body").trigger("checkout_error"),s.unblock())}},dataType:"html"})),!1},o.prototype.processOrderPay=function(){var t=this.uuid,o=this,e=n("input[name=payment_method]:checked",this.$paymentForm).val();return-1===_.flatten(_.values(this.options.paymentMethods)).indexOf(e)||(s.is_blocked(this.$paymentForm)||(s.block(this.$paymentForm),this._registerPaymentCallback(),n.ajax({type:"POST",url:_pafw.ajax_url,data:{action:_pafw.slug+"-pafw_ajax_action",payment_method:e,payment_action:"process_order_pay",order_id:_pafw.order_id,order_key:_pafw.order_key,data:this.$paymentForm.serialize(),_wpnonce:_pafw._wpnonce},success:function(e){void 0!==e&&void 0!==e.success&&!0===e.success?o.openPaymentWindow(t,e.data):alert(e.data),s.unblock()}})),!1)},o.prototype.destroy=function(){},n("body").trigger("pafw_init_hook"),_.each(e,function(e,t){n(e).pafw({})})});