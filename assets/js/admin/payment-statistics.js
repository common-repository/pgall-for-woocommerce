jQuery(document).ready(function($){"use strict";var date_from="",date_to="",is_blocked=function(e){return e.is(".processing")||e.parents(".processing").length},block=function(e){is_blocked(e)||e.addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock=function(e){e.removeClass("processing").unblock()},payment_statistics_chart=(AmCharts.addInitHandler(function(e){void 0!==e.applyGapValue&&void 0!==e.categoryAxis&&!0===e.categoryAxis.parseDates&&AmCharts.applyGapValue.processData(e,!1)},["serial"]),AmCharts.applyGapValue={getDate:function(e,a){return"string"==typeof e&&void 0!==a?AmCharts.stringToDate(e,a):new Date(e)},formatDate:function(e,a,t){return"string"==typeof a&&void 0!==t?AmCharts.formatDate(e,t):"number"==typeof a?e.getTime():e},getPeriod:function(e){e=e||"DD";e=AmCharts.extractPeriod(e);return AmCharts.getPeriodDuration(e.period,e.count)},addPeriod:function(e,a,t){a=a||"DD";var a=AmCharts.extractPeriod(a),l=new Date(e);switch(a.period){case"YYYY":l.setFullYear(l.getFullYear()+t);break;case"MM":l.setFullYear(l.getFullYear(),l.getMonth()+t);break;case"DD":l.setFullYear(l.getFullYear(),l.getMonth(),l.getDate()+t);break;case"hh":l.setHours(l.getHours()+t);break;case"mm":l.setHours(l.getHours(),l.getMinutes()+t);break;case"ss":l.setHours(l.getHours(),l.getMinutes(),l.getSeconds()+t);break;case"fff":l.setTime(l.getTime()+t)}return l},processData:function(e,a){var t=0,l=e.dataProvider,o=e.categoryField,r=e.dataDateFormat;if(AmCharts.ifArray(l)&&0!==l.length){AmCharts.applyGapValue.getDate(l[0][o],r),AmCharts.applyGapValue.getDate(l[l.length-1][o],r);for(var s=l[0][o],n=[],i=0;i<l.length;i++){var d=parseInt(l[i].success),p=parseInt(l[i].negative);if(l[i].success_rate=d+p===0?100:(d/(d+p)*100).toFixed(2),!0===e.accumulateValue&&(t+=parseFloat(l[i].value),l[i].acc_value=t),n.push(l[i]),i+1<l.length)for(var d=l[i+1],c=AmCharts.applyGapValue.getDate(d[o]),u=AmCharts.applyGapValue.addPeriod(AmCharts.applyGapValue.getDate(l[i][o]),e.categoryAxis.minPeriod,e.pafwGapValue);u<c;){var h={};h[o]=AmCharts.applyGapValue.formatDate(u,s,e.dataDateFormat);for(var m=0;m<e.graphs.length;m++)!0===e.accumulateValue?(h[e.graphs[m].valueField]=e.applyGapValue,h.acc_value=t):h[e.graphs[m].valueField]=e.applyGapValue;h.success_rate=100,n.push(h),u=AmCharts.applyGapValue.addPeriod(u,e.categoryAxis.minPeriod,e.pafwGapValue)}}e.dataProvider=n,a&&e.validateData()}}},AmCharts.makeChart("payment_statistics_chart",{type:"serial",theme:"light",applyGapValue:0,pafwGapValue:1,legend:{useGraphSettings:!0,markerSize:10,valueText:"",valueWidth:0},addClassNames:!0,startDuration:0,mouseWheelZoomEnabled:!1,dataDateFormat:"YYYY-MM-DD",valueAxes:[{gridAlpha:0,position:"right",title:"건수"},{id:"rate",axisAlpha:0,gridAlpha:.07,position:"left",minimum:0,title:"결제성공율(%)"}],balloon:{borderThickness:1,shadowAlpha:0},graphs:[{id:"success_rate",balloonText:"<span style='font-size:10px;'>[[title]] <span style='font-size:12px; font-weight: bold;'>[[value]]%</span></span>",lineColor:"#05aa00",bullet:"round",bulletBorderAlpha:1,bulletColor:"#FFFFFF",bulletSize:5,hideBulletsCount:50,lineThickness:2,useLineColorForBulletBorder:!0,title:"결제성공율",type:"smoothedLine",valueAxis:"rate",valueField:"success_rate"},{balloonText:"<span style='font-size:10px;'>[[title]] <span style='font-size:12px; font-weight: bold;'>[[value]]건</span></span>",lineColor:"#cc4748",bullet:"round",bulletBorderAlpha:1,bulletColor:"#FFFFFF",bulletSize:5,hideBulletsCount:50,useLineColorForBulletBorder:!0,title:"결제실패",hidden:!0,type:"smoothedLine",valueField:"negative"},{balloonText:"<span style='font-size:10px;'>[[title]] <span style='font-size:12px; font-weight: bold;'>[[value]]건</span></span>",bullet:"round",bulletBorderAlpha:1,bulletColor:"#FFFFFF",bulletSize:5,hideBulletsCount:50,hidden:!0,useLineColorForBulletBorder:!0,title:"결제포기",type:"smoothedLine",valueField:"positive"},{id:"success",balloonText:"<span style='font-size:10px;'>[[title]] <span style='font-size:12px; font-weight: bold;'>[[value]]건</span></span>",lineColor:"#5C9BD1",bullet:"round",bulletBorderAlpha:1,bulletColor:"#FFFFFF",bulletSize:5,hideBulletsCount:50,useLineColorForBulletBorder:!0,title:"결제성공",hidden:!0,type:"smoothedLine",valueField:"success"}],chartScrollbar:{graph:"success_rate",oppositeAxis:!1,offset:10,scrollbarHeight:40,dragIconHeight:20,backgroundAlpha:0,selectedBackgroundAlpha:.1,selectedBackgroundColor:"#888888",graphFillAlpha:0,graphLineAlpha:.5,selectedGraphFillAlpha:0,selectedGraphLineAlpha:1,autoGridCount:!1,color:"#AAAAAA"},chartCursor:{pan:!0,valueLineEnabled:!0,valueLineBalloonEnabled:!0,cursorAlpha:1,cursorColor:"#258cbb",limitToGraph:"amount",valueLineAlpha:.2,valueZoomable:!0,categoryBalloonFunction:function(e){return e.toLocaleDateString("ko")}},categoryField:"pafw_date",categoryAxis:{equalSpacing:!0,parseDates:!0,dashLength:1,labelFunction:function(e,a,t){return a.toLocaleDateString("en",{month:"numeric",day:"numeric"})}},export:{enabled:!0,exportTitles:!0,exportFields:["pafw_date","success_rate","negative","positive","success"],fileName:"pgall"},dataProvider:[]})),device_sales_chart=AmCharts.makeChart("device_sales_chart",{type:"serial",theme:"light",applyGapValue:0,pafwGapValue:1,legend:{useGraphSettings:!0,markerSize:10,valueText:"",valueWidth:0},addClassNames:!0,startDuration:0,mouseWheelZoomEnabled:!1,dataDateFormat:"YYYY-MM-DD",valueAxes:[{gridAlpha:.07,position:"left",title:"건수"},{id:"amountAxes",axisAlpha:0,gridAlpha:0,position:"right",title:"매출액"}],balloon:{borderThickness:1,shadowAlpha:0},graphs:[{balloonText:"<span style='font-size:10px;'>[[title]] <span style='font-size:12px; font-weight: bold;'>[[value]]건</span></span>",bullet:"round",bulletBorderAlpha:1,bulletSize:5,lineThickness:2,hideBulletsCount:50,useLineColorForBulletBorder:!0,title:"PC",type:"smoothedLine",valueField:"pc_count"},{balloonText:"<span style='font-size:10px;'>[[title]] <span style='font-size:12px; font-weight: bold;'>[[value]]건</span></span>",bullet:"round",bulletBorderAlpha:1,bulletSize:5,lineThickness:2,hideBulletsCount:50,useLineColorForBulletBorder:!0,title:"모바일",type:"smoothedLine",valueField:"mobile_count"}],chartScrollbar:{oppositeAxis:!1,offset:10,scrollbarHeight:40,dragIconHeight:20,backgroundAlpha:0,selectedBackgroundAlpha:.1,selectedBackgroundColor:"#888888",graphFillAlpha:0,graphLineAlpha:.5,selectedGraphFillAlpha:0,selectedGraphLineAlpha:1,autoGridCount:!1,color:"#AAAAAA"},chartCursor:{pan:!0,valueLineEnabled:!0,valueLineBalloonEnabled:!0,cursorAlpha:1,cursorColor:"#258cbb",limitToGraph:"amount",valueLineAlpha:.2,valueZoomable:!0,categoryBalloonFunction:function(e){return e.toLocaleDateString("ko")}},categoryField:"pafw_date",categoryAxis:{equalSpacing:!0,parseDates:!0,dashLength:1,labelFunction:function(e,a,t){return a.toLocaleDateString("en",{month:"numeric",day:"numeric"})}},export:{enabled:!0,exportTitles:!0,exportFields:["pafw_date","pc_count","mobile_count"],fileName:"pgall"},dataProvider:[]}),completed_count_by_payment_method=AmCharts.makeChart("completed_count_by_payment_method",{type:"pie",theme:"light",labelText:"[[percents]]%",valueField:"count",titleField:"payment_method_title",colorField:"color",alpha:.9,balloon:{fixedPosition:!0},pullOutRadius:0,legend:{position:"bottom",labelWidth:100,autoMargins:!1},dataProvider:[]}),failed_count_by_result_code=AmCharts.makeChart("failed_count_by_result_code",{type:"pie",theme:"light",labelText:"[[percents]]%",valueField:"error_count",titleField:"message",colorField:"color",alpha:.9,balloon:{fixedPosition:!0},pullOutRadius:0,legend:{position:"right",equalWidths:"false",width:550,labelWidth:300},dataProvider:[]}),failed_count_by_device_type_chart=AmCharts.makeChart("failed_count_by_device_type",{type:"pie",theme:"light",labelText:"[[percents]]%",valueField:"count",titleField:"device_type",colorField:"color",alpha:.9,balloon:{fixedPosition:!0},marginTop:15,marginBottom:15,marginLeft:0,marginRight:0,pullOutRadius:0,legend:{position:"bottom",autoMargins:!1},dataProvider:[]});function zoomChart(){var e=payment_statistics_chart.dataProvider.length;30<e&&(payment_statistics_chart.zoomToIndexes(e-30,e-1),device_sales_chart.zoomToIndexes(e-30,e-1))}function get_dashboard_data(from,to){block($("#pafw-dashboard-wrapper")),$.ajax({type:"post",dataType:"json",url:ajaxurl,data:{action:_pafw_payment_statistics.action,command:"get_data",date_from:from,date_to:to,interval:$(".search-interval.selected").data("interval")},success:function(response){response.success?($.each(response.data,function(key,value){var fn="process_"+key;eval("typeof "+fn+" == 'function'")&&eval(fn)(value)}),zoomChart()):alert(response.data.message),unblock($("#pafw-dashboard-wrapper"))},error:function(){unblock($("#pafw-dashboard-wrapper"))}})}function process_order_stat_by_date(e){payment_statistics_chart.dataProvider=e,AmCharts.applyGapValue.processData(payment_statistics_chart,!0)}function process_device_sales_data(e){device_sales_chart.dataProvider=e,AmCharts.applyGapValue.processData(device_sales_chart,!0)}function update_pie_chart(e,a){var t;0===a.length?((t={})[e.titleField]="",t[e.valueField]=1,a.push(t),(t={})[e.titleField]="",t[e.valueField]=1,a.push(t),(t={})[e.titleField]="",t[e.valueField]=1,a.push(t),e.labelsEnabled=!1,e.alpha=.3,e.legend.enabled=!1):(e.labelsEnabled=!0,e.alpha=1,e.legend.enabled=!0),e.dataProvider=a,e.validateData()}function process_completed_count_by_payment_method(e){update_pie_chart(completed_count_by_payment_method,e)}function process_failed_count_by_result_code(e){update_pie_chart(failed_count_by_result_code,e)}function process_failed_count_by_device_type(e){update_pie_chart(failed_count_by_device_type_chart,e)}function process_payment_statistics(e){$("div.pafw-dashboard-stat .request span.amount").html(e.request.count),$("div.pafw-dashboard-stat .completed span.amount").html(e.completed.count),$("div.pafw-dashboard-stat .completed span.count").html(e.completed.percent),$("div.pafw-dashboard-stat .cancelled span.amount").html(e.cancelled.count),$("div.pafw-dashboard-stat .cancelled span.count").html(e.cancelled.percent),$("div.pafw-dashboard-stat .failed span.amount").html(e.failed.count),$("div.pafw-dashboard-stat .failed span.count").html(e.failed.percent)}$("#reportrange").daterangepicker({locale:{format:"YYYY-MM-DD",separator:" - ",applyLabel:"적용",cancelLabel:"취소",fromLabel:"시작일자",toLabel:"끝일자",customRangeLabel:"범위선택",weekLabel:"W",daysOfWeek:["일","월","화","수","목","금","토"],monthNames:["1월","2월","3월","4월","5월","6월","7월","8월","9월","10월","11월","12월"],firstDay:1},alwaysShowCalendars:!0,opens:"right",startDate:_pafw_payment_statistics.start_date,endDate:_pafw_payment_statistics.end_date,maxDate:moment(),ranges:{"지난 30일":[moment().subtract(29,"days"),moment()],"지난 90일":[moment().subtract(89,"days"),moment()],"지난 180일":[moment().subtract(179,"days"),moment()],"이번달":[moment().startOf("month"),moment().endOf("month")],"지난달":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]}}),$("#reportrange").on("apply.daterangepicker",function(e,a){date_from=$("#reportrange").data("daterangepicker").startDate.format("YYYY-MM-DD"),date_to=$("#reportrange").data("daterangepicker").endDate.format("YYYY-MM-DD"),$("#reportrange span").html(date_from+" - "+date_to),get_dashboard_data(date_from,date_to)}.bind(this)),date_from=_pafw_payment_statistics.start_date,date_to=_pafw_payment_statistics.end_date,get_dashboard_data(_pafw_payment_statistics.start_date,_pafw_payment_statistics.end_date),$(".search-interval").on("click",function(){var e=$(this).data("interval"),a=$(this).data("gap_value");payment_statistics_chart.pafwGapValue=a,device_sales_chart.pafwGapValue=a,"1M"==e?(payment_statistics_chart.categoryAxis.minPeriod="MM",device_sales_chart.categoryAxis.minPeriod="MM"):(payment_statistics_chart.categoryAxis.minPeriod="DD",device_sales_chart.categoryAxis.minPeriod="DD"),$(".search-interval").removeClass("selected"),$(".search-interval[data-interval="+e+"]").addClass("selected"),$("#reportrange").trigger("apply.daterangepicker")})});